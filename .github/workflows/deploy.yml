name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # 수동 실행 가능

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        cd violincoachAI
        npm ci
        
    - name: Build frontend
      run: |
        cd violincoachAI
        npm run build
        
    - name: Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
        
    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
      run: |
        # EC2에 디렉토리 생성
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} \
          "sudo mkdir -p /var/www/violincoach && sudo chown -R ${EC2_USER}:${EC2_USER} /var/www/violincoach"
        
        # 프론트엔드 파일 업로드
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -r violincoachAI/dist/* \
          ${EC2_USER}@${EC2_HOST}:/var/www/violincoach/
        
        # Nginx 설정 업데이트 (필요시)
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
          violincoachAI/backend/nginx/violincoach-full.conf \
          ${EC2_USER}@${EC2_HOST}:/tmp/violincoach.conf
        
        # Nginx 재시작
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} \
          "sudo cp /tmp/violincoach.conf /etc/nginx/sites-available/violincoach && \
           sudo nginx -t && \
           sudo systemctl restart nginx"
        
    - name: Verify deployment
      run: |
        curl -f http://${{ secrets.EC2_HOST }}/health || exit 1

